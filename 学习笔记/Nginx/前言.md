# Nginx

## 1.简单请求和非简单请求

### 1.1 简单请求

+ 请求方法是`HEAD`、`GET`、`POST`三种之一
+ HTTP头信息不超过`Accept`、`Accept-Language`、`Content-Language`、`Last-Event-ID`、`Content-Type` 只限于三个值 `application/x-www-form-urlencoded`、`multipart/form-data`、`text/plain`；

> 对于简单请求来说，游览器在发起请求的时候会在头信息增加Origin字段后直接发出，Origin字段用来说明本次请求来自哪个源。
>
> 如果服务器没有包含 `Access-Control-Allow-Origin` 响应头，或者该头的值不允许当前的源(`Origin`指定的源)访问，浏览器会将该响应视为一个跨域请求，并抛出一个错误，通常会触发 XHR 的 `error` 事件。值得注意的是，这个返回的HTTP响应的状态码有可能是200.

> 如果服务端配置了 `Access-Control-Allow-Origin` 头字段，则服务器会返回一个正常的 HTTP 回应告知浏览器该请求被拒绝，并指定允许的源。
>
> 如果没有配置 `Access-Control-Allow-Origin` ，则返回的回应中也不会携带 `Access-Control-Allow-Origin`

> Content-Type 只限于`application/x-www-form-urlencoded`、`multipart/form-data`、`text/plain`,但是一般我们用**axios**发送post请求时，常用于对数据库产生一些副作用，所以会携带json数据，也就是说头`Content-Type`会自动配置`application/json`值,这也是尽管没怎么去配置HTTP头，但是预检请求也会发起的原因

### 1.2 非简单请求

不满足简单请求的要求的都是非简单请求，非简单请求的一大特点是会发送预检请求(preflight),在正式发送带有请求体的请求之前，浏览器会向服务端发送一次只包含头部信息的预检请求(options)，去询问服务端可以支持的自定义头、请求的方法等，如果不符合就不会请求，避免造成资源的浪费

> 预见请求包含三个字段，其中关键字段是`Origin`表示请求的源，还包括`Access-Control-Request-Method`用来列出CORS请求会用到的HTTP方法，以及`Access-Control-Request-Headers`用来表示会额外发送的头信息(可以用于知晓是哪些头信息导致的预检请求)

> 服务器在收到浏览器的预检请求之后，会根据头信息的三个字段来进行判断是否允许跨域请求，只要服务器通过了预检请求，在以后每次的CORS请求都会自带一个Origin头信息字段。
>
> 服务器的回应，也都会有一个Access-Control-Allow-Origin头信息字段。在非简单请求中，至少需要设置以下字段`Access-Control-Allow-Origin`表示允许跨域的源地址、`Access-Control-Allow-Methods`表示服务器支持的所有跨域请求的方法、`Access-Control-Allow-Headers`表示服务器支持的所有头信息字段

> 对于附带身份凭证的请求(即服务器设置Access-Control-Allow-Credentials: true)，服务器不得设置 Access-Control-Allow-Origin 的值为"\*"。否则请求将会失败。Cookie遵循同源策略，即使因为这个请求是跨域请求，但是每个Origin的Cookie是不能被其他Origin获取到的，也就是不允许Access-Control-Allow-Origin 的值为"\*"

> 由于preflight请求属于CORS规范的一部分，因此当前仅当跨域的情况下可能会触发preflight。也即：**只有跨域了，且不满足之前触发条件中一条就会触发预检请求。没有跨域，不会触发预检请求。**

#### 1.2.1 减少预检请求

可以在后端返回头中添加头部字段:"Access-Control-Max-Age",他的值是一个数字，单位是秒，表示预检请求可以被缓存多久，在这时间内再次发起请求就不会进行预检请求了(当然这个需要关闭“禁用缓存”)

#### 1.2.2 以express为例来配置响应头

```js
app.use((req, res, next) => {
  // 允许跨域请求
  res.header("Access-Control-Allow-Origin", "http://localhost:5501");
  // 允许使用的请求方法
  res.header("Access-Control-Allow-Methods", "GET, POST, PUT, DELETE, OPTIONS");
  // 允许使用的请求头字段
  res.header(
    "Access-Control-Allow-Headers",
    "Content-Type, Authorization, X-Requested-With"
  );
  res.header("X-Powered-By", " 3.2.1");
  res.header("Content-Type", "application/json;charset=utf-8");
  // 如果是预检请求（OPTIONS），则直接返回 200
  if (req.method === "OPTIONS") {
    res.sendStatus(200);
  } else {
    next();
  }
});
```

